@page "/profile"
@attribute [Authorize]
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IRiskService RiskService

<PageTitle>My Profile - Apollo Risk</PageTitle>

<div class="profile-page">
    <div class="page-header">
        <div class="header-icon">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
        </div>
        <div class="header-content">
            <h1>My Profile</h1>
            <p>View and manage your account information</p>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="loading-container">
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
        </div>
    }
    else
    {
        <div class="profile-layout">
            <!-- Profile Card -->
            <div class="card profile-card">
                <div class="profile-header-section">
                    <div class="profile-avatar-large">
                        @GetInitials(displayName)
                    </div>
                    <div class="profile-name-section">
                        <h2>@displayName</h2>
                        <span class="profile-role">@userRole</span>
                    </div>
                </div>

                <div class="profile-details">
                    <div class="detail-group">
                        <div class="detail-icon">
                            <RadzenIcon Icon="email" />
                        </div>
                        <div class="detail-content">
                            <label>Email Address</label>
                            <span>@userEmail</span>
                        </div>
                    </div>

                    @if (userDetails != null)
                    {
                        <div class="detail-group">
                            <div class="detail-icon">
                                <RadzenIcon Icon="badge" />
                            </div>
                            <div class="detail-content">
                                <label>User ID</label>
                                <span>@userDetails.Id</span>
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(userDetails.PortfolioName))
                        {
                            <div class="detail-group">
                                <div class="detail-icon">
                                    <RadzenIcon Icon="folder" />
                                </div>
                                <div class="detail-content">
                                    <label>Portfolio</label>
                                    <span>@userDetails.PortfolioName</span>
                                </div>
                            </div>
                        }
                    }

                    <div class="detail-group">
                        <div class="detail-icon">
                            <RadzenIcon Icon="security" />
                        </div>
                        <div class="detail-content">
                            <label>Role</label>
                            <span>@userRole</span>
                        </div>
                    </div>

                    <div class="detail-group">
                        <div class="detail-icon">
                            <RadzenIcon Icon="login" />
                        </div>
                        <div class="detail-content">
                            <label>Last Login</label>
                            <span>@DateTime.Now.ToString("dd MMM yyyy HH:mm")</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <RadzenIcon Icon="flash_on" style="color: var(--primary-color);" />
                        Quick Actions
                    </h3>
                </div>
                <div class="card-body">
                    <div class="quick-actions">
                        <a href="/trdashboard" class="action-item">
                            <div class="action-icon">
                                <RadzenIcon Icon="dashboard" />
                            </div>
                            <div class="action-content">
                                <span class="action-title">Risk Dashboard</span>
                                <span class="action-description">View risk overview and KPIs</span>
                            </div>
                            <RadzenIcon Icon="chevron_right" class="action-arrow" />
                        </a>

                        <a href="/risksummary" class="action-item">
                            <div class="action-icon warning">
                                <RadzenIcon Icon="summarize" />
                            </div>
                            <div class="action-content">
                                <span class="action-title">Risk Summary</span>
                                <span class="action-description">View detailed reports</span>
                            </div>
                            <RadzenIcon Icon="chevron_right" class="action-arrow" />
                        </a>

                        <a href="/variancereport" class="action-item">
                            <div class="action-icon info">
                                <RadzenIcon Icon="compare_arrows" />
                            </div>
                            <div class="action-content">
                                <span class="action-title">Variance Report</span>
                                <span class="action-description">Track score changes</span>
                            </div>
                            <RadzenIcon Icon="chevron_right" class="action-arrow" />
                        </a>
                    </div>
                </div>
            </div>

            <!-- Account Info -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <RadzenIcon Icon="info" style="color: var(--info-color);" />
                        Account Information
                    </h3>
                </div>
                <div class="card-body">
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Account Status</span>
                            <span class="status-badge active">Active</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Authentication</span>
                            <span class="info-value">Azure AD</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Session</span>
                            <span class="info-value">@DateTime.Now.ToString("dd MMM yyyy")</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool isLoading = true;
    private string displayName = "User";
    private string userEmail = "";
    private string userRole = "User";
    private UserDto? userDetails;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user?.Identity?.IsAuthenticated == true)
            {
                displayName = user.Identity.Name ??
                             user.FindFirst("name")?.Value ??
                             "User";

                userEmail = user.FindFirst("email")?.Value ??
                           user.FindFirst("preferred_username")?.Value ??
                           "";

                // Try to get detailed user info from service
                if (!string.IsNullOrEmpty(userEmail))
                {
                    try
                    {
                        userDetails = await RiskService.GetUserByEmailAsync(userEmail);
                        if (userDetails?.RoleName != null)
                        {
                            userRole = userDetails.RoleName;
                        }
                    }
                    catch
                    {
                        // User not found in database, use auth claims
                    }
                }

                // Check for role claims
                var roleClaim = user.FindFirst("roles")?.Value ??
                               user.FindFirst("role")?.Value;
                if (!string.IsNullOrEmpty(roleClaim) && userRole == "User")
                {
                    userRole = roleClaim;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading profile: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "U";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[^1][0]}".ToUpper();
        return name[0].ToString().ToUpper();
    }
}

<style>
    .profile-page {
        max-width: 1000px;
        margin: 0 auto;
    }

    .profile-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }

    .profile-card {
        grid-column: 1 / -1;
    }

    .profile-header-section {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        padding: 1.5rem;
        background: transparent;
        border-radius: 12px 12px 0 0;
        margin: -1.5rem -1.5rem 1.5rem;
    }

    .profile-avatar-large {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 1.75rem;
        box-shadow: 0 4px 16px rgba(245, 158, 11, 0.3);
    }

    .profile-name-section h2 {
        margin: 0 0 0.25rem;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .profile-role {
        font-size: 0.9375rem;
        color: var(--primary-color);
        font-weight: 500;
    }

    .profile-details {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .detail-group {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: var(--bg-light);
        border-radius: 10px;
    }

    .detail-icon {
        width: 44px;
        height: 44px;
        background: rgba(245, 158, 11, 0.1);
        color: var(--primary-color);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .detail-content {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

        .detail-content label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }

        .detail-content span {
            font-size: 0.9375rem;
            font-weight: 500;
            color: var(--text-primary);
        }

    /* Quick Actions */
    .quick-actions {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .action-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: var(--bg-light);
        border-radius: 10px;
        text-decoration: none;
        transition: all 0.2s;
    }

        .action-item:hover {
            background: rgba(245, 158, 11, 0.1);
            transform: translateX(4px);
        }

    .action-icon {
        width: 44px;
        height: 44px;
        background: rgba(245, 158, 11, 0.1);
        color: var(--primary-color);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .action-icon.warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        .action-icon.info {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info-color);
        }

    .action-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .action-title {
        font-size: 0.9375rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .action-description {
        font-size: 0.8125rem;
        color: var(--text-muted);
    }

    .action-arrow {
        color: var(--text-muted);
    }

    /* Info Grid */
    .info-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        padding: 1rem;
        background: var(--bg-light);
        border-radius: 10px;
        text-align: center;
    }

    .info-label {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
    }

    .info-value {
        font-size: 0.9375rem;
        font-weight: 500;
        color: var(--text-primary);
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.8125rem;
        font-weight: 600;
    }

        .status-badge.active {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

    @@media (max-width: 768px) {
        .profile-layout {
            grid-template-columns: 1fr;
        }

        .info-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
