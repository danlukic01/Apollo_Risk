@page "/manageusers"
@inject IRiskService RiskService

<PageTitle>Manage Users - Apollo Risk</PageTitle>

<div class="settings-page">
    <div class="page-header">
        <div class="header-content">
            <div class="header-icon">
                <RadzenIcon Icon="people" />
            </div>
            <div>
                <h1>Manage Users</h1>
                <p>Configure system users and their roles</p>
            </div>
        </div>
        <div class="header-actions">
            <RadzenButton Icon="add" Text="Add User" ButtonStyle="ButtonStyle.Primary" Click="@ShowAddDialog" />
        </div>
    </div>

    <!-- Filters -->
    <div class="filter-card">
        <div class="filter-grid">
            <div class="filter-item">
                <label>Role</label>
                <RadzenDropDown @bind-Value="@filterRoleId"
                                Data="@roles"
                                TextProperty="Name"
                                ValueProperty="Id"
                                Placeholder="All Roles"
                                AllowClear="true"
                                Change="@OnFilterChanged"
                                Style="width: 100%;" />
            </div>
            <div class="filter-item">
                <label>Search</label>
                <RadzenTextBox @bind-Value="@searchText"
                               Placeholder="Search by name or email..."
                               Change="@OnSearchChanged"
                               Style="width: 100%;" />
            </div>
        </div>
    </div>

    <!-- Users Grid -->
    <div class="data-card">
        @if (isLoading)
        {
            <div class="loading-container">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                <span>Loading users...</span>
            </div>
        }
        else
        {
            <RadzenDataGrid @ref="usersGrid"
                            Data="@filteredUsers"
                            TItem="UserDto"
                            AllowFiltering="true"
                            AllowSorting="true"
                            AllowPaging="true"
                            PageSize="15"
                            PagerHorizontalAlign="HorizontalAlign.Center"
                            ShowPagingSummary="true"
                            Class="risk-data-grid">
                <Columns>
                    <RadzenDataGridColumn TItem="UserDto" Property="Id" Title="ID" Width="80px" TextAlign="TextAlign.Center" />
                    <RadzenDataGridColumn TItem="UserDto" Property="Name" Title="Name" Width="200px">
                        <Template Context="item">
                            <div class="user-cell">
                                <div class="user-avatar-small">@GetInitials(item.Name)</div>
                                <span class="user-name">@item.Name</span>
                            </div>
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="UserDto" Property="Email" Title="Email" Width="250px" />
                    <RadzenDataGridColumn TItem="UserDto" Property="RoleName" Title="Role" Width="150px">
                        <Template Context="item">
                            <span class="role-badge">@(item.RoleName ?? "No Role")</span>
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="UserDto" Title="Risks Owned" Width="120px" TextAlign="TextAlign.Center">
                        <Template Context="item">
                            <span class="count-badge">@(GetRiskCount(item.Id))</span>
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="UserDto" Title="Actions" Width="120px" TextAlign="TextAlign.Center" Sortable="false" Filterable="false">
                        <Template Context="item">
                            <div class="action-buttons">
                                <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" Click="@(() => ShowEditDialog(item))" title="Edit" />
                                <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Click="@(() => ConfirmDelete(item))" title="Delete" />
                            </div>
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        }
    </div>

    <!-- Help Section -->
    <DynamicHelpSection PageKey="ManageUsers" />

    <!-- Add/Edit Dialog -->
    @if (showDialog)
    {
        <div class="modal-overlay" @onclick="CloseDialog">
            <div class="modal-dialog" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h3>@(isEditing ? "Edit User" : "Add User")</h3>
                    <button class="modal-close" @onclick="CloseDialog">
                        <RadzenIcon Icon="close" />
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Name *</label>
                            <RadzenTextBox @bind-Value="@currentUser.Name"
                                           Placeholder="Enter full name"
                                           Style="width: 100%;" />
                        </div>
                        <div class="form-group">
                            <label>Email *</label>
                            <RadzenTextBox @bind-Value="@currentUser.Email"
                                           Placeholder="Enter email address"
                                           Style="width: 100%;" />
                        </div>
                        <div class="form-group">
                            <label>Role</label>
                            <RadzenDropDown @bind-Value="@currentUser.RoleId"
                                            Data="@roles"
                                            TextProperty="Name"
                                            ValueProperty="Id"
                                            Placeholder="Select Role"
                                            AllowClear="true"
                                            Style="width: 100%;" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@CloseDialog" />
                    <RadzenButton Text="@(isEditing ? "Update" : "Create")" ButtonStyle="ButtonStyle.Primary" Click="@SaveUser" />
                </div>
            </div>
        </div>
    }

    <!-- Delete Confirmation -->
    @if (showDeleteConfirm)
    {
        <div class="modal-overlay" @onclick="CloseDeleteConfirm">
            <div class="modal-dialog small" @onclick:stopPropagation="true">
                <div class="modal-header danger">
                    <h3>Delete User</h3>
                    <button class="modal-close" @onclick="CloseDeleteConfirm">
                        <RadzenIcon Icon="close" />
                    </button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this user?</p>
                    <div class="delete-details">
                        <strong>@userToDelete?.Name</strong>
                        <br />
                        <span class="text-muted">@userToDelete?.Email</span>
                    </div>
                    <p class="warning-text">This may affect risks assigned to this user.</p>
                </div>
                <div class="modal-footer">
                    <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@CloseDeleteConfirm" />
                    <RadzenButton Text="Delete" ButtonStyle="ButtonStyle.Danger" Click="@DeleteUser" />
                </div>
            </div>
        </div>
    }
</div>

<style>
    .settings-page {
        padding: 0;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .header-content {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .header-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: linear-gradient(135deg, #ffd170 0%, #ffb347 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #1e293b;
    }

    .page-header h1 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0;
    }

    .page-header p {
        color: #64748b;
        margin: 0.25rem 0 0;
        font-size: 0.875rem;
    }

    .filter-card {
        background: white;
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border: 1px solid #e2e8f0;
    }

    .settings-page .filter-card {
        position: sticky;
        top: 5.5rem;
        z-index: 45;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: 200px 1fr;
        gap: 1rem;
        align-items: end;
    }

    .filter-item label {
        display: block;
        font-size: 0.75rem;
        font-weight: 600;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
    }

    .data-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 4px 12px rgba(0,0,0,0.03);
        border: 1px solid #e2e8f0;
        margin-bottom: 1.5rem;
    }

    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 3rem;
        gap: 1rem;
        color: #64748b;
    }

    .user-cell {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .user-avatar-small {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ffd170 0%, #ffb347 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
        color: #1e293b;
    }

    .user-name {
        font-weight: 500;
        color: #1e293b;
    }

    .role-badge {
        display: inline-flex;
        padding: 0.25rem 0.75rem;
        background: rgba(99, 102, 241, 0.1);
        color: #6366f1;
        border-radius: 9999px;
        font-size: 0.8125rem;
        font-weight: 500;
    }

    .count-badge {
        display: inline-flex;
        padding: 0.25rem 0.75rem;
        background: rgba(245, 158, 11, 0.1);
        color: #F59E0B;
        border-radius: 9999px;
        font-size: 0.8125rem;
        font-weight: 500;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(4px);
    }

    .modal-dialog {
        background: white;
        border-radius: 12px;
        width: 100%;
        max-width: 500px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
    }

        .modal-dialog.small {
            max-width: 450px;
        }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #e2e8f0;
    }

        .modal-header.danger {
            background: #fef2f2;
        }

            .modal-header.danger h3 {
                color: #dc2626;
            }

        .modal-header h3 {
            margin: 0;
            font-size: 1.125rem;
            font-weight: 600;
        }

    .modal-close {
        background: none;
        border: none;
        border-radius: 8px;
        padding: 0.5rem;
        cursor: pointer;
        color: #64748b;
        display: flex;
    }

        .modal-close:hover {
            background: #f1f5f9;
        }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        padding: 1rem 1.5rem;
        border-top: 1px solid #e2e8f0;
        background: #f8fafc;
        border-radius: 0 0 12px 12px;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

        .form-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

    .delete-details {
        background: #f8fafc;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        margin: 1rem 0;
    }

    .text-muted {
        color: #64748b;
        font-size: 0.875rem;
    }

    .warning-text {
        color: #d97706;
        font-size: 0.875rem;
    }

    /* Dark Mode */
    :global(html.theme-dark) .filter-card,
    :global(html.theme-dark) .data-card {
        background: #1e293b;
        border-color: #334155;
    }

    :global(html.theme-dark) .page-header h1,
    :global(html.theme-dark) .user-name {
        color: #f1f5f9;
    }

    :global(html.theme-dark) .page-header p,
    :global(html.theme-dark) .filter-item label {
        color: #94a3b8;
    }

    :global(html.theme-dark) .modal-dialog {
        background: #1e293b;
    }

    :global(html.theme-dark) .modal-header {
        border-color: #334155;
    }

    :global(html.theme-dark) .modal-body {
        color: #f1f5f9;
    }

    :global(html.theme-dark) .modal-footer {
        background: #0f172a;
        border-color: #334155;
    }

    :global(html.theme-dark) .form-group label {
        color: #e2e8f0;
    }

    :global(html.theme-dark) .delete-details {
        background: #0f172a;
        border-color: #334155;
    }

    @@media (max-width: 768px) {
        .filter-grid {
            grid-template-columns: 1fr;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

@code {
    private RadzenDataGrid<UserDto>? usersGrid;

    private List<UserDto> users = new();
    private List<UserDto> filteredUsers = new();
    private List<RoleDto> roles = new();
    private Dictionary<int, int> riskCounts = new();

    private int? filterRoleId;
    private string searchText = "";

    private bool isLoading = true;
    private bool showDialog = false;
    private bool isEditing = false;
    private bool showDeleteConfirm = false;

    private UserDto currentUser = new();
    private UserDto? userToDelete;

    protected override async Task OnInitializedAsync()
    {
        await LoadLookups();
        await LoadData();
    }

    private async Task LoadLookups()
    {
        try
        {
            roles = await RiskService.GetRolesAsync() ?? new();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading lookups: {ex.Message}");
        }
    }

    private async Task LoadData()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            users = await RiskService.GetUsersAsync() ?? new();

            // Load risk counts per user
            var risks = await RiskService.GetAllTRRisksAsync() ?? new();
            riskCounts = risks.GroupBy(r => r.OwnerId).ToDictionary(g => g.Key, g => g.Count());

            FilterData();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading users: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void FilterData()
    {
        filteredUsers = users.Where(u =>
            (!filterRoleId.HasValue || u.RoleId == filterRoleId) &&
            (string.IsNullOrWhiteSpace(searchText) ||
             (u.Name?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
             (u.Email?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false))
        ).ToList();
    }

    private void OnFilterChanged(object value)
    {
        FilterData();
    }

    private void OnSearchChanged(string value)
    {
        FilterData();
    }

    private int GetRiskCount(int userId) => riskCounts.GetValueOrDefault(userId, 0);

    private string GetInitials(string? name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "U";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[^1][0]}".ToUpper();
        return name[0].ToString().ToUpper();
    }

    private void ShowAddDialog()
    {
        currentUser = new UserDto();
        isEditing = false;
        showDialog = true;
    }

    private void ShowEditDialog(UserDto user)
    {
        currentUser = new UserDto
            {
                Id = user.Id,
                Name = user.Name,
                Email = user.Email,
                RoleId = user.RoleId,
                PortfolioId = user.PortfolioId
            };
        isEditing = true;
        showDialog = true;
    }

    private void CloseDialog()
    {
        showDialog = false;
        currentUser = new();
    }

    private async Task SaveUser()
    {
        if (string.IsNullOrWhiteSpace(currentUser.Name) || string.IsNullOrWhiteSpace(currentUser.Email))
            return;

        try
        {
            if (isEditing)
                await RiskService.UpdateUserAsync(currentUser);
            else
                await RiskService.CreateUserAsync(currentUser);

            CloseDialog();
            await LoadData();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving user: {ex.Message}");
        }
    }

    private void ConfirmDelete(UserDto user)
    {
        userToDelete = user;
        showDeleteConfirm = true;
    }

    private void CloseDeleteConfirm()
    {
        showDeleteConfirm = false;
        userToDelete = null;
    }

    private async Task DeleteUser()
    {
        if (userToDelete != null)
        {
            try
            {
                await RiskService.DeleteUserAsync(userToDelete.Id);
                CloseDeleteConfirm();
                await LoadData();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error deleting user: {ex.Message}");
            }
        }
    }
}
