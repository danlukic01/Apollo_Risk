@page "/riskcategories"
@inject IRiskService RiskService

<PageTitle>Risk Categories - Apollo Risk</PageTitle>

<div class="settings-page">
    <div class="page-header">
        <div class="header-content">
            <div class="header-icon">
                <RadzenIcon Icon="folder_special" />
            </div>
            <div>
                <h1>Risk Categories</h1>
                <p>Manage risk classification categories</p>
            </div>
        </div>
        <div class="header-actions">
            <RadzenButton Icon="add" Text="Add Category" ButtonStyle="ButtonStyle.Primary" Click="@ShowAddDialog" />
        </div>
    </div>

    <!-- Filters -->
    <div class="filter-card">
        <div class="filter-grid">
            <div class="filter-item">
                <label>Service</label>
                <RadzenDropDown @bind-Value="@filterServiceId"
                                Data="@services"
                                TextProperty="Name"
                                ValueProperty="Id"
                                Placeholder="All Services"
                                AllowClear="true"
                                Change="@OnFilterChanged"
                                Style="width: 100%;" />
            </div>
            <div class="filter-item">
                <label>Domain</label>
                <RadzenDropDown @bind-Value="@filterDomainId"
                                Data="@domains"
                                TextProperty="Name"
                                ValueProperty="Id"
                                Placeholder="All Domains"
                                AllowClear="true"
                                Change="@OnFilterChanged"
                                Style="width: 100%;" />
            </div>
            <div class="filter-item">
                <label>Search</label>
                <RadzenTextBox @bind-Value="@searchText"
                               Placeholder="Search categories..."
                               Change="@OnSearchChanged"
                               Style="width: 100%;" />
            </div>
        </div>
    </div>

    <!-- Categories Grid -->
    <div class="data-card">
        @if (isLoading)
        {
            <div class="loading-container">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                <span>Loading categories...</span>
            </div>
        }
        else
        {
            <RadzenDataGrid @ref="categoriesGrid"
                            Data="@filteredCategories"
                            TItem="RiskCategoryDto"
                            AllowFiltering="true"
                            AllowSorting="true"
                            AllowPaging="true"
                            PageSize="15"
                            PagerHorizontalAlign="HorizontalAlign.Center"
                            ShowPagingSummary="true"
                            Class="risk-data-grid">
                <Columns>
                    <RadzenDataGridColumn TItem="RiskCategoryDto" Property="Id" Title="ID" Width="80px" TextAlign="TextAlign.Center" />
                    <RadzenDataGridColumn TItem="RiskCategoryDto" Property="Name" Title="Category Name" Width="250px">
                        <Template Context="item">
                            <div class="category-cell">
                                <span class="category-name">@item.Name</span>
                                @if (!string.IsNullOrEmpty(item.Description))
                                {
                                    <span class="category-desc">@item.Description</span>
                                }
                            </div>
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="RiskCategoryDto" Property="ServiceName" Title="Service" Width="150px" />
                    <RadzenDataGridColumn TItem="RiskCategoryDto" Property="DomainName" Title="Domain" Width="150px" />
                    <RadzenDataGridColumn TItem="RiskCategoryDto" Title="Risks" Width="100px" TextAlign="TextAlign.Center">
                        <Template Context="item">
                            <span class="count-badge">@(GetRiskCount(item.Id))</span>
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="RiskCategoryDto" Title="Actions" Width="120px" TextAlign="TextAlign.Center" Sortable="false" Filterable="false">
                        <Template Context="item">
                            <div class="action-buttons">
                                <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" Click="@(() => ShowEditDialog(item))" title="Edit" />
                                <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Click="@(() => ConfirmDelete(item))" title="Delete" />
                            </div>
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        }
    </div>

    <!-- Help Section -->
    <DynamicHelpSection PageKey="RiskCategories" />

    <!-- Add/Edit Dialog -->
    @if (showDialog)
    {
        <div class="modal-overlay" @onclick="CloseDialog">
            <div class="modal-dialog" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h3>@(isEditing ? "Edit Category" : "Add Category")</h3>
                    <button class="modal-close" @onclick="CloseDialog">
                        <RadzenIcon Icon="close" />
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Category Name *</label>
                            <RadzenTextBox @bind-Value="@currentCategory.Name"
                                           Placeholder="Enter category name"
                                           Style="width: 100%;" />
                        </div>
                        <div class="form-group full-width">
                            <label>Description</label>
                            <RadzenTextArea @bind-Value="@currentCategory.Description"
                                            Placeholder="Enter description"
                                            Rows="3"
                                            Style="width: 100%;" />
                        </div>
                        <div class="form-group">
                            <label>Service *</label>
                            <RadzenDropDown @bind-Value="@currentCategory.ServiceId"
                                            Data="@services"
                                            TextProperty="Name"
                                            ValueProperty="Id"
                                            Placeholder="Select Service"
                                            Style="width: 100%;" />
                        </div>
                        <div class="form-group">
                            <label>Domain *</label>
                            <RadzenDropDown @bind-Value="@currentCategory.DomainId"
                                            Data="@domains"
                                            TextProperty="Name"
                                            ValueProperty="Id"
                                            Placeholder="Select Domain"
                                            Style="width: 100%;" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@CloseDialog" />
                    <RadzenButton Text="@(isEditing ? "Update" : "Create")" ButtonStyle="ButtonStyle.Primary" Click="@SaveCategory" />
                </div>
            </div>
        </div>
    }

    <!-- Delete Confirmation -->
    @if (showDeleteConfirm)
    {
        <div class="modal-overlay" @onclick="CloseDeleteConfirm">
            <div class="modal-dialog small" @onclick:stopPropagation="true">
                <div class="modal-header danger">
                    <h3>Delete Category</h3>
                    <button class="modal-close" @onclick="CloseDeleteConfirm">
                        <RadzenIcon Icon="close" />
                    </button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this category?</p>
                    <p class="delete-details"><strong>@categoryToDelete?.Name</strong></p>
                    <p class="warning-text">This may affect associated risks and thresholds.</p>
                </div>
                <div class="modal-footer">
                    <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@CloseDeleteConfirm" />
                    <RadzenButton Text="Delete" ButtonStyle="ButtonStyle.Danger" Click="@DeleteCategory" />
                </div>
            </div>
        </div>
    }
</div>

<style>
    .settings-page {
        padding: 0;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .header-content {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .header-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: linear-gradient(135deg, #ffd170 0%, #ffb347 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #1e293b;
    }

    .page-header h1 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0;
    }

    .page-header p {
        color: #64748b;
        font-size: 0.875rem;
        margin: 0.25rem 0 0;
    }

    .filter-card {
        background: white;
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border: 1px solid #e2e8f0;
    }

    .settings-page .filter-card {
        position: sticky;
        top: 5.5rem;
        z-index: 45;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 1rem;
    }

    .filter-item label {
        display: block;
        font-size: 0.75rem;
        font-weight: 600;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
    }

    .data-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 4px 12px rgba(0,0,0,0.03);
        border: 1px solid #e2e8f0;
        margin-bottom: 1.5rem;
    }

    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 3rem;
        gap: 1rem;
        color: #64748b;
    }

    .category-cell {
        display: flex;
        flex-direction: column;
    }

    .category-name {
        font-weight: 500;
        color: #1e293b;
    }

    .category-desc {
        font-size: 0.75rem;
        color: #64748b;
    }

    .count-badge {
        display: inline-flex;
        padding: 0.25rem 0.75rem;
        background: rgba(245, 158, 11, 0.1);
        color: #F59E0B;
        border-radius: 9999px;
        font-size: 0.8125rem;
        font-weight: 500;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(4px);
    }

    .modal-dialog {
        background: white;
        border-radius: 12px;
        width: 100%;
        max-width: 550px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
    }

        .modal-dialog.small {
            max-width: 450px;
        }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #e2e8f0;
    }

        .modal-header.danger {
            background: #fef2f2;
        }

            .modal-header.danger h3 {
                color: #dc2626;
            }

        .modal-header h3 {
            margin: 0;
            font-size: 1.125rem;
            font-weight: 600;
        }

    .modal-close {
        background: none;
        border: none;
        border-radius: 8px;
        padding: 0.5rem;
        cursor: pointer;
        color: #64748b;
        display: flex;
    }

        .modal-close:hover {
            background: #f1f5f9;
        }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        padding: 1rem 1.5rem;
        border-top: 1px solid #e2e8f0;
        background: #f8fafc;
        border-radius: 0 0 12px 12px;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

        .form-group.full-width {
            grid-column: span 2;
        }

        .form-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

    .delete-details {
        background: #f8fafc;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        margin: 1rem 0;
    }

    .warning-text {
        color: #d97706;
        font-size: 0.875rem;
    }

    /* Dark Mode */
    :global(html.theme-dark) .filter-card,
    :global(html.theme-dark) .data-card {
        background: #1e293b;
        border-color: #334155;
    }

    :global(html.theme-dark) .page-header h1,
    :global(html.theme-dark) .category-name {
        color: #f1f5f9;
    }

    :global(html.theme-dark) .page-header p,
    :global(html.theme-dark) .filter-item label {
        color: #94a3b8;
    }

    :global(html.theme-dark) .modal-dialog {
        background: #1e293b;
    }

    :global(html.theme-dark) .modal-header {
        border-color: #334155;
    }

    :global(html.theme-dark) .modal-body {
        color: #f1f5f9;
    }

    :global(html.theme-dark) .modal-footer {
        background: #0f172a;
        border-color: #334155;
    }

    :global(html.theme-dark) .form-group label {
        color: #e2e8f0;
    }

    :global(html.theme-dark) .delete-details {
        background: #0f172a;
        border-color: #334155;
    }

    @@media (max-width: 768px) {
        .filter-grid,
        .form-grid {
            grid-template-columns: 1fr;
        }

        .form-group.full-width {
            grid-column: 1;
        }
    }
</style>

@code {
    private RadzenDataGrid<RiskCategoryDto>? categoriesGrid;

    private List<RiskCategoryDto> categories = new();
    private List<RiskCategoryDto> filteredCategories = new();
    private List<ServiceDto> services = new();
    private List<DomainDto> domains = new();
    private Dictionary<int, int> riskCounts = new();

    private int? filterServiceId;
    private int? filterDomainId;
    private string searchText = "";

    private bool isLoading = true;
    private bool showDialog = false;
    private bool isEditing = false;
    private bool showDeleteConfirm = false;

    private RiskCategoryDto currentCategory = new();
    private RiskCategoryDto? categoryToDelete;

    protected override async Task OnInitializedAsync()
    {
        await LoadLookups();
        await LoadData();
    }

    private async Task LoadLookups()
    {
        try
        {
            services = await RiskService.GetServicesAsync() ?? new();
            domains = await RiskService.GetAllDomainsAsync() ?? new();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading lookups: {ex.Message}");
        }
    }

    private async Task LoadData()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            categories = await RiskService.GetCategoriesAsync() ?? new();
            var risks = await RiskService.GetAllTRRisksAsync() ?? new();
            riskCounts = risks.GroupBy(r => r.RiskCategoryId).ToDictionary(g => g.Key, g => g.Count());
            FilterData();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading categories: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void FilterData()
    {
        filteredCategories = categories.Where(c =>
            (!filterServiceId.HasValue || c.ServiceId == filterServiceId) &&
            (!filterDomainId.HasValue || c.DomainId == filterDomainId) &&
            (string.IsNullOrWhiteSpace(searchText) ||
             (c.Name?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
             (c.Description?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false))
        ).ToList();
    }

    private void OnFilterChanged(object value)
    {
        FilterData();
    }

    private void OnSearchChanged(string value)
    {
        FilterData();
    }

    private int GetRiskCount(int categoryId) => riskCounts.GetValueOrDefault(categoryId, 0);

    private void ShowAddDialog()
    {
        currentCategory = new RiskCategoryDto();
        isEditing = false;
        showDialog = true;
    }

    private void ShowEditDialog(RiskCategoryDto category)
    {
        currentCategory = new RiskCategoryDto
            {
                Id = category.Id,
                Name = category.Name,
                Description = category.Description,
                ServiceId = category.ServiceId,
                DomainId = category.DomainId
            };
        isEditing = true;
        showDialog = true;
    }

    private void CloseDialog()
    {
        showDialog = false;
        currentCategory = new();
    }

    private async Task SaveCategory()
    {
        if (string.IsNullOrWhiteSpace(currentCategory.Name)) return;

        try
        {
            if (isEditing)
                await RiskService.UpdateRiskCategoryAsync(currentCategory);
            else
                await RiskService.CreateRiskCategoryAsync(currentCategory);

            CloseDialog();
            await LoadData();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving category: {ex.Message}");
        }
    }

    private void ConfirmDelete(RiskCategoryDto category)
    {
        categoryToDelete = category;
        showDeleteConfirm = true;
    }

    private void CloseDeleteConfirm()
    {
        showDeleteConfirm = false;
        categoryToDelete = null;
    }

    private async Task DeleteCategory()
    {
        if (categoryToDelete != null)
        {
            try
            {
                await RiskService.DeleteRiskCategoryAsync(categoryToDelete.Id);
                CloseDeleteConfirm();
                await LoadData();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error deleting category: {ex.Message}");
            }
        }
    }
}
